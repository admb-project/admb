.PHONY: admb tpl2cpp tpl2rem docs tests contrib

all: admb contrib
	@rm -rf admb
	@ln -vs build/@target@/ admb
	@printf "\nADMB build completed in 'build/@target@'.\n"
	@printf "To install, read README.txt.\n"

admb:
	@arvar@ CC=@cc@ CFLAGS="@cflags@" CXX=@cxx@ CXXFLAGS="@cxxflags@" LIBPATH=@libpath@ DISK=@disk@ ADMB_CONFIGURE=1 $(MAKE) --directory=src --file=@makefile@
	rm -rf `find build/@target@ -type d -name .svn`

tpl2cpp:
	$(MAKE) --directory=src/nh99 --file=optg32-rh8-laplace.mak $@.c $@

tpl2rem:
	$(MAKE) --directory=src/df1b2-separable --file=optg32-rh8-laplace.mak $@.c $@

debug:
	DEBUG=1 CC=@cc@ CXX=@cxx@ CXXFLAGS="@cxxflags@" LIBPATH=@libpath@ DISK=@disk@ ADMB_CONFIGURE=1 $(MAKE) --directory=src --file=@makefile@
	rm -rf `find build/@target@ -type d -name .svn`
	@printf "\nBuild completed for @target@\n"
	@printf "To install ADMB to '@prefix@/bin' and '@prefix@/admb', type 'make install'\n"

docs:
	$(MAKE) --directory=docs

dist:
	mkdir -p build/dist
	rm -rf build/dist/admb@version@
	svn export . build/dist/admb@version@
	rm -rf build/dist/admb@version@/tests
	cp configure build/dist/admb@version@
	cd build/dist && rm -vf admb@version@.zip && zip -r admb@version@.zip admb@version@

verify:
	DISK=@disk@ ADMB_HOME="" ADMB_CXXFLAGS="@cxxflags@" ADMB_LDFLAGS="@cxxflags@" $(MAKE) --directory=src --file=@makefile@ verify

checkstyle:
	-python2 utilities/cpplint.py --filter=-whitespace/braces src/linad99/*.cpp src/linad99/*.hpp src/nh99/*.cpp src/nh99/*.hpp src/tools99/*.cpp src/tools99/*.hpp src/sparse/*.cpp src/sparse/*.hpp

install:
	install -d -m 755 @prefix@/admb/bin @prefix@/admb/include @prefix@/admb/lib @prefix@/admb/docs @prefix@/admb/examples @prefix@/admb/contrib
	install -m 755 build/@target@/bin/* @prefix@/admb/bin
	install -m 644 build/@target@/include/* @prefix@/admb/include
	install -m 644 build/@target@/lib/* @prefix@/admb/lib
	install -m 644 build/@target@/contrib/* @prefix@/admb/contrib
	install -m 644 LICENSE.txt @prefix@/admb
	install -m 644 README.txt @prefix@/admb
	install -m 644 Makefile @prefix@/admb
	install -m 644 scripts/admb/admb-bin @prefix@/admb/bin
	cp -Rf build/@target@/docs/* @prefix@/admb/docs
	cp -Rf build/@target@/examples/* @prefix@/admb/examples

zip:
	cd build && rm -vf @target2@.zip && zip -r @target2@.zip @target@

dmg:
	@dmgtask@

tests:
	export ADMB_HOME="${PWD}/build/@target@"; export PATH="${PWD}/build/@target@/bin:${PATH}"; CXXFLAGS="@cxxflags@" LDFLAGS="@cxxflags@" $(MAKE) --directory=tests main

contrib:
	@arvar@ CC=@cc@ CXX=@cxx@ CXXFLAGS="@cxxflags@" LIBPATH=@libpath@ DISK=@disk@ $(MAKE) --directory=contrib

clean:
	rm -rvf build/@target@
	rm -rvf build/objects/@target@
	$(MAKE) --directory=src --file=@makefile@ clean
	$(MAKE) --directory=tests clean
	$(MAKE) --directory=scripts/configure clean
	LIBPATH=@libpath@ DISK=@disk@ $(MAKE) --directory=contrib clean
